<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDMH Performance Evaluation Portal</title>
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Subtle Background Watermark */
        body::before {
            content: '\f0f8';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40rem;
            color: #1e3a8a;
            opacity: 0.02;
            pointer-events: none;
            z-index: -1;
        }

        .brand-serif { font-family: 'Playfair Display', serif; }

        /* Premium Dashboard Cards */
        .eval-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 2.5rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
            border: 1px solid rgba(226, 232, 240, 0.5);
            border-bottom: 5px solid transparent;
            position: relative;
            cursor: pointer;
        }

        .eval-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .card-blue { border-bottom-color: #1e3a8a; }
        .card-amber { border-bottom-color: #fbbf24; }
        .card-green { border-bottom-color: #22c55e; }

        .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .card-footer-link {
            margin-top: auto;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1.5rem;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .eval-card:hover .card-footer-link {
            opacity: 1;
        }

        /* HR Admin Trigger */
        .hr-admin-top-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 9999;
            background-color: #1e3a8a;
            color: white;
            padding: 10px 22px;
            border-radius: 0.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }

        .hr-admin-top-btn:hover {
            background-color: #172554;
            transform: translateY(-2px);
        }

        /* Fancy Underline */
        .fancy-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2rem;
            width: 100%;
        }
        .fancy-line {
            height: 2px;
            background: linear-gradient(to right, transparent, #fbbf24 20%, #fbbf24 80%, transparent);
            width: 450px;
            max-width: 90vw;
            position: relative;
        }
        .fancy-line::before {
            content: '♦';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #fbbf24;
            background: #ffffff;
            padding: 0 15px;
            font-size: 14px;
        }

        /* Master Table Styling */
        .admin-grid-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .admin-grid-table th {
            background: #1e3a8a;
            color: white;
            padding: 1.25rem;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-align: center;
        }
        .admin-grid-table td {
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            vertical-align: top;
            text-align: center;
        }

        /* Modals */
        #admin-modal, #security-modal, #app-overlay, #admin-login-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
        }

        /* FIX: Higher Z-Index for Admin Dashboard to ensure it sits over overlays */
        #admin-modal { z-index: 20000; }

        .modal-backdrop {
            background: rgba(15, 23, 42, 0.96);
            backdrop-filter: blur(8px);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        /* Professional Inputs */
        .clean-input {
            width: 100%;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            padding: 1.25rem;
            border-radius: 1rem;
            text-align: center;
            font-weight: 800;
            outline: none;
            transition: all 0.3s;
        }

        .clean-input:focus {
            border-color: #1e3a8a;
            background: white;
            box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.05);
        }

        * { font-style: normal !important; }
        
        .brand-serif-normal { 
            font-family: 'Playfair Display', serif;
            font-style: normal !important; 
        }

        @media (max-width: 640px) {
            .eval-card h2 { font-size: 1.05rem !important; }
            .fancy-line { width: 80vw; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">

    <script>
        const URL_ANNUAL = "https://script.google.com/macros/s/AKfycbz8u5KkJCQWcLcJtp9KYIXaFUby8EYoG264UvrD1nBkTOWS1RmzYbQ3cexOYBNM3kvs/exec";
        const URL_PROBATION = "https://script.google.com/macros/s/AKfycbwID1MQoYtJOobLZ_J9tJVlPA-sSGXUaZso6jLnPLb5MPvdVuLgdl9WGxQivcQxHbwrZg/exec";
    </script>

    <!-- HEADER AREA -->
    <header class="pt-24 pb-16 px-8 text-center relative">
        <button onclick="showAdminLogin()" class="hr-admin-top-btn">
            <i class="fa-solid fa-lock text-xs"></i>
            <span>HR Admin Access</span>
        </button>

        <div class="max-w-5xl mx-auto">
            <img src="https://raw.githubusercontent.com/tdmh-cqi/hr-performance-evaluation/main/images%20logo/tdmh-logo.png" 
                 alt="TDMH Logo" class="h-32 md:h-40 mx-auto mb-8 drop-shadow-sm">
            
            <div class="flex flex-col items-center">
                <h1 class="brand-serif text-2xl md:text-3xl font-black text-[#0f172a] leading-tight tracking-tight uppercase">
                    Performance Evaluation Portal
                </h1>
                <p class="brand-serif text-lg md:text-xl font-black text-[#1e3a8a] mt-2 opacity-90">
                    (P.E.P.)
                </p>
                <div class="fancy-divider">
                    <div class="fancy-line"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- DASHBOARD GRID -->
    <main class="flex-grow flex items-center justify-center pb-24 pt-4 px-6 md:px-12">
        <div class="max-w-6xl w-full grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-10">
            
            <!-- ANNUAL / REGULAR -->
            <div class="eval-card card-blue group" onclick="launchApplication('annual')">
                <div class="icon-circle bg-blue-50 text-[#1e3a8a] group-hover:bg-[#1e3a8a] group-hover:text-white">
                    <i class="fa-solid fa-calendar-check text-2xl"></i>
                </div>
                <h2 class="text-base md:text-lg font-black text-slate-800 tracking-tighter mb-4">Annual / Regular</h2>
                <p class="text-slate-400 font-medium text-xs md:text-sm leading-relaxed mb-8 px-2">
                    Evaluations for hospital staff who have reached regular employment status.
                </p>
                <div class="card-footer-link text-[#1e3a8a]">
                    <span>Initialize Evaluator Form</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>

            <!-- PROBATIONARY -->
            <div class="eval-card card-amber group" onclick="launchApplication('probation')">
                <div class="icon-circle bg-amber-50 text-[#d97706] group-hover:bg-[#facc15] group-hover:text-slate-900">
                    <i class="fa-solid fa-stopwatch text-2xl"></i>
                </div>
                <h2 class="text-base md:text-lg font-black text-slate-800 tracking-tighter mb-4">Probationary</h2>
                <p class="text-slate-400 font-medium text-xs md:text-sm leading-relaxed mb-8 px-2">
                    Performance monitoring for 3rd and 5th month hiring milestones.
                </p>
                <div class="card-footer-link text-[#d97706]">
                    <span>Start Assessment Cycle</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>

            <!-- ACKNOWLEDGEMENT -->
            <div class="eval-card card-green group" onclick="openSecurityGateway()">
                <div class="icon-circle bg-green-50 text-[#16a34a] group-hover:bg-[#22c55e] group-hover:text-white">
                    <i class="fa-solid fa-signature text-2xl"></i>
                </div>
                <h2 class="text-base md:text-lg font-black text-slate-800 tracking-tighter mb-4">Employee Acknowledgement</h2>
                <p class="text-slate-400 font-medium text-xs md:text-sm leading-relaxed mb-8 px-2">
                    Access verified records and provide your digital signature to finalize.
                </p>
                <div class="card-footer-link text-[#16a34a]">
                    <span>Open Secured Record</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-[#0f172a] text-white py-16 px-10 text-center border-t-8 border-[#1e3a8a]">
        <div class="max-w-5xl mx-auto space-y-8">
            <div class="inline-block border border-slate-700 px-8 py-4 rounded-full bg-slate-800/20">
                <p class="text-[#fbbf24] tracking-[0.05em] text-[11px] md:text-sm uppercase">
                    <span class="brand-serif-normal">Continuous Quality Improvement</span>
                    <span class="text-white font-black font-sans mx-1">(CQI)</span>
                    <span class="brand-serif-normal">Optimization</span>
                </p>
            </div>
            <div>
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.2em]">
                    © 2026 TAYTAY DOCTORS MULTISPECIALTY HOSPITAL. ALL RIGHTS RESERVED.
                </p>
            </div>
        </div>
    </footer>

    <!-- ADMIN LOGIN MODAL -->
    <div id="admin-login-modal">
        <div class="modal-backdrop">
            <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 text-center relative shadow-2xl">
                <button onclick="closeAdminLogin()" class="absolute top-6 right-6 text-slate-300 text-3xl hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h3 class="text-xl font-black uppercase mb-1 tracking-tighter">HR Authorization</h3>
                <p class="text-slate-400 font-bold uppercase text-[9px] tracking-[0.1em] mb-8">Access Master Records</p>
                
                <input type="password" id="admin-pin-display" placeholder="••••••••" 
                       class="clean-input text-2xl tracking-[0.8em] mb-6 focus:border-slate-900">
                
                <button onclick="verifyAdminPin()" class="w-full bg-[#1e3a8a] text-white font-black py-5 rounded-2xl text-xs uppercase tracking-widest border-b-4 border-blue-950 active:scale-95 transition-all">
                    Unlock Portal
                </button>
                <p id="admin-login-error" class="text-red-600 font-bold text-[10px] mt-6 uppercase hidden tracking-widest">Unauthorized Entry</p>
            </div>
        </div>
    </div>

    <!-- MASTER ADMIN MODAL -->
    <div id="admin-modal">
        <div class="modal-backdrop">
            <div class="bg-white w-full max-w-6xl rounded-[3rem] p-12 relative shadow-2xl overflow-hidden border-[10px] border-slate-50">
                <button onclick="closeAdminDashboard()" class="absolute top-10 right-10 text-slate-300 hover:text-red-500 text-5xl transition-all">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
                <h2 class="text-3xl font-black text-slate-900 uppercase mb-2 tracking-tighter">Master Verification Dashboard</h2>
                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-10">Departmental Data Hub</p>
                
                <div class="overflow-x-auto rounded-[1.5rem] border border-slate-100 max-h-[60vh] overflow-y-auto">
                    <table class="admin-grid-table">
                        <thead>
                            <tr>
                                <th>Annual / Regular</th>
                                <th>3rd Month (Prob)</th>
                                <th>5th Month (Prob)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic Content Injected Here -->
                            <tr>
                                <td colspan="3">
                                    <div class="text-slate-200 py-16">
                                        <i class="fa-solid fa-database text-5xl mb-4 block"></i>
                                        <span class="text-[9px] font-black uppercase tracking-[0.3em]">No Pending Verification Requests</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- SECURITY GATEWAY MODAL -->
    <div id="security-modal">
        <div class="modal-backdrop">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] p-12 text-center relative shadow-2xl">
                <button onclick="closeSecurityGateway()" class="absolute top-8 right-8 text-slate-300 text-3xl hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h3 class="text-xl font-black uppercase mb-1 tracking-tighter">Identity Verification</h3>
                <p class="text-slate-400 font-bold uppercase text-[9px] tracking-[0.1em] mb-8">Enter Evaluation Reference ID</p>
                
                <input type="text" id="record-id-field" placeholder="••••••••" 
                       class="clean-input text-xl uppercase tracking-widest mb-6">
                
                <button onclick="validateAndLaunch()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl text-xs uppercase tracking-widest border-b-4 border-slate-700 active:scale-95 transition-all">
                    Access Record
                </button>
            </div>
        </div>
    </div>

    <!-- APP OVERLAY -->
    <!-- TERMINATE BUTTON REMOVED as requested -->
    <div id="app-overlay" class="flex-col bg-white">
        <div class="bg-slate-900 text-white h-20 flex justify-between items-center px-8 md:px-12 shrink-0 border-b-4 border-blue-600/20 shadow-xl">
            <div class="flex items-center gap-5">
                <img src="https://raw.githubusercontent.com/tdmh-cqi/hr-performance-evaluation/main/images%20logo/tdmh-logo.png" class="h-8 bg-white p-1 rounded">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase tracking-[0.3em] text-blue-400 leading-none mb-1">Authenticated</span>
                    <span class="text-xs font-black text-slate-400 uppercase tracking-widest block">Secure Data Stream</span>
                </div>
            </div>
            
            <!-- FALLBACK CLOSE ICON (Subtle X) -->
            <button onclick="forceCloseOverlay()" class="text-slate-500 hover:text-red-500 transition-colors text-xl" title="Force Close Session">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="flex-grow relative bg-slate-50">
            <!-- CRITICAL FIX: allow-top-navigation -->
            <iframe id="portal-iframe-host" class="w-full h-full border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-top-navigation"></iframe>
        </div>
    </div>

    <script>
        function showAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'block';
            document.getElementById('admin-login-error').classList.add('hidden');
            document.getElementById('admin-pin-display').value = '';
            setTimeout(() => document.getElementById('admin-pin-display').focus(), 200);
        }

        function closeAdminLogin() {
            document.getElementById('admin-login-modal').style.display = 'none';
        }

        function verifyAdminPin() {
            const pin = document.getElementById('admin-pin-display').value;
            if (pin === "TDMHCQI/HR2025") {
                closeAdminLogin();
                openAdminDashboard();
                fetchDashboardData(pin); // FIX: Fetch Logic
            } else {
                document.getElementById('admin-login-error').classList.remove('hidden');
            }
        }

        function openAdminDashboard() {
            document.getElementById('admin-modal').style.display = 'block';
        }
        
        function closeAdminDashboard() { 
            document.getElementById('admin-modal').style.display = 'none'; 
        }
        
        function openSecurityGateway() { 
            document.getElementById('security-modal').style.display = 'block'; 
            setTimeout(() => document.getElementById('record-id-field').focus(), 200);
        }
        
        function closeSecurityGateway() { 
            document.getElementById('security-modal').style.display = 'none'; 
        }

        function validateAndLaunch() {
            const id = document.getElementById('record-id-field').value.trim().toUpperCase();
            if (!id) return;
            
            let context = "";
            if (id.startsWith('ANN')) context = 'annual';
            else if (id.startsWith('PROB')) context = 'probation';
            else {
                alert("Invalid Reference ID Format. Ensure it starts with ANN- or PROB-");
                return;
            }

            closeSecurityGateway();
            launchApplication(context, `?view=employee&id=${id}&sigColor=black`);
        }

        function launchApplication(context, params = "") {
            const overlay = document.getElementById('app-overlay');
            const iframe = document.getElementById('portal-iframe-host');
            let url = (context === 'annual') ? URL_ANNUAL : URL_PROBATION;
            
            if (params) {
                const connector = url.includes('?') ? '&' : '?';
                url += connector + params.replace(/^\?/, '');
            }
            
            overlay.style.display = 'flex';
            iframe.src = url;
        }

        function forceCloseOverlay() {
            document.getElementById('app-overlay').style.display = 'none';
            document.getElementById('portal-iframe-host').src = 'about:blank';
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({path: cleanUrl}, '', cleanUrl);
        }

        async function fetchDashboardData(pin) {
            const tbody = document.querySelector('.admin-grid-table tbody');
            tbody.innerHTML = '<tr><td colspan="3"><div class="py-12"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i><p class="text-xs font-bold uppercase tracking-widest text-slate-400">Syncing Secure Records...</p></div></td></tr>';

            try {
                const [annRes, probRes] = await Promise.all([
                    fetch(URL_ANNUAL + `?view=adminData&pin=${encodeURIComponent(pin)}`).then(r => r.json()).catch(e => []),
                    fetch(URL_PROBATION + `?view=adminData&pin=${encodeURIComponent(pin)}`).then(r => r.json()).catch(e => [])
                ]);

                const annualList = Array.isArray(annRes) ? annRes : [];
                const prob3List = Array.isArray(probRes) ? probRes.filter(r => r.phase === "3rd Month") : [];
                const prob5List = Array.isArray(probRes) ? probRes.filter(r => r.phase === "5th Month") : [];

                renderDashboardTable(annualList, prob3List, prob5List);

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-red-500 font-bold py-10">Data Sync Failed: ${e.message}</td></tr>`;
            }
        }

        function renderDashboardTable(annual, prob3, prob5) {
            const tbody = document.querySelector('.admin-grid-table tbody');
            tbody.innerHTML = '';

            const maxRows = Math.max(annual.length, prob3.length, prob5.length);

            if (maxRows === 0) {
                tbody.innerHTML = '<tr><td colspan="3"><div class="text-slate-200 py-16"><i class="fa-solid fa-database text-5xl mb-4 block"></i><span class="text-[9px] font-black uppercase tracking-[0.3em]">No Pending Verification Requests</span></div></td></tr>';
                return;
            }

            for (let i = 0; i < maxRows; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${renderCellItem(annual[i], 'annual')}</td>
                    <td>${renderCellItem(prob3[i], 'probation')}</td>
                    <td>${renderCellItem(prob5[i], 'probation')}</td>
                `;
                tbody.appendChild(row);
            }
        }

        function renderCellItem(item, context) {
            if (!item) return '';
            return `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-left hover:border-blue-500 transition-all group shadow-sm hover:shadow-md">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-black text-[#1e3a8a] text-sm leading-tight">${item.name}</div>
                        <span class="bg-blue-100 text-blue-800 text-[9px] font-bold px-1.5 py-0.5 rounded">PENDING</span>
                    </div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">
                        Evaluator: <span class="text-slate-600 font-bold">${item.evaluator || 'N/A'}</span>
                    </div>
                    <button onclick="launchApplication('${context}', '?view=admin&id=${item.id}')" 
                            class="w-full bg-[#1e3a8a] text-white text-[10px] font-bold py-3 rounded-lg uppercase tracking-widest opacity-90 group-hover:opacity-100 transition-all hover:bg-blue-800">
                        Review Record <i class="fa-solid fa-arrow-right ml-1"></i>
                    </button>
                </div>
            `;
        }

        window.onload = function() {
            const urlSearch = new URLSearchParams(window.location.search);
            const autoId = urlSearch.get('id');
            const system = urlSearch.get('sys');
            const view = urlSearch.get('view');

            if (autoId && !system) {
                openSecurityGateway();
                document.getElementById('record-id-field').value = autoId;
                setTimeout(() => validateAndLaunch(), 800);
            } else if (system && view === 'admin') {
                showAdminLogin();
            }
        };

        document.getElementById('admin-pin-display').addEventListener('keypress', (e) => { if(e.key === 'Enter') verifyAdminPin(); });
        document.getElementById('record-id-field').addEventListener('keypress', (e) => { if(e.key === 'Enter') validateAndLaunch(); });
    </script>
</body>
</html>
